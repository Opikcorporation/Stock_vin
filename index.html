<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Stock en Ligne - La Boutique Concept</title>
    <style>
        :root {
            --primary-color: #007aff;
            --primary-light-color: #e6f2ff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --text-color: #1d1d1f;
            --text-light-color: #6e6e73;
            --background-color: #f5f5f7;
            --card-background-color: #ffffff;
            --border-color: #e5e5e7;
            --border-radius: 12px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .header { text-align: center; margin-bottom: 32px; }
        .header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 4px; }
        .header h2 { font-size: 1.25rem; font-weight: 400; color: var(--text-light-color); }
        .nav-tabs { display: flex; gap: 8px; margin-bottom: 32px; border-bottom: 1px solid var(--border-color); overflow-x: auto; }
        .nav-tab { padding: 12px 18px; background: none; border: none; font-size: 1rem; font-weight: 500; color: var(--text-light-color); cursor: pointer; transition: all 0.2s ease-in-out; border-bottom: 3px solid transparent; position: relative; top: 1px; white-space: nowrap; }
        .nav-tab:hover { color: var(--text-color); }
        .nav-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background-color: var(--card-background-color); padding: 24px 32px; border-radius: var(--border-radius); margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
        .card-header { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--background-color); }
        .card-title { font-size: 1.5rem; font-weight: 600; }
        .form-group { margin-bottom: 16px; position: relative; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; background-color: #fdfdfd; }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-light-color); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .btn:disabled { background-color: #e9e9eb; color: #aaa; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { opacity: 0.85; }
        .btn-secondary { background-color: #e9e9eb; color: var(--text-color); }
        .btn-secondary:hover:not(:disabled) { background-color: #dcdce0; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover:not(:disabled) { opacity: 0.85; }
        .btn-small { padding: 6px 12px; font-size: 0.8rem; }
        .form-actions { display: flex; gap: 12px; margin-top: 24px; flex-wrap: wrap; }
        .table-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 16px; flex-wrap: wrap; }
        .sort-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .sort-controls label { font-weight: 500; color: var(--text-light-color); }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-weight: 600; font-size: 0.85rem; color: var(--text-light-color); text-transform: uppercase; letter-spacing: 0.5px; background-color: var(--background-color); }
        tbody tr:hover { background-color: #fafafa; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .low-stock-card { background: var(--card-background-color); padding: 20px; border-radius: var(--border-radius); border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .low-stock-card .info { display: flex; flex-direction: column; }
        .low-stock-card .name { font-weight: 600; font-size: 1.1rem; }
        .low-stock-card .type { font-size: 0.8rem; padding: 2px 8px; border-radius: 6px; display: inline-block; margin-top: 4px; color: white; }
        .low-stock-card .stock { font-size: 2.5rem; font-weight: 700; line-height: 1; }
        .stock.critical { color: var(--danger-color); }
        .stock.warning { color: var(--warning-color); }
        .wine-entries { display: flex; flex-direction: column; gap: 16px; background-color: var(--background-color); padding: 16px; border-radius: 8px; margin-top: 24px; }
        .wine-entry { background: var(--card-background-color); padding: 16px; border-radius: 8px; display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 16px; align-items: flex-start; }
        .remove-btn { height: 45px; padding: 0 16px; margin-top: 29px; }
        .stock-validator { font-size: 0.85rem; margin-top: 6px; min-height: 1.4em; }
        .stock-validator.valid { color: var(--success-color); }
        .stock-validator.invalid { color: var(--danger-color); }
        .type-badge { font-size: 0.8rem; padding: 3px 10px; border-radius: 12px; color: white; display: inline-block; text-transform: capitalize; }
        .badge-rouge { background-color: #9b2226; }
        .badge-blanc { background-color: #f7d351; color: #333; }
        .badge-rose { background-color: #f2a6a6; color: #333; }
        .badge-champagne { background-color: #e8bd4a; color: #333; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; display: inline-block; text-transform: uppercase; }
        .status-in { background-color: #d1f4d1; color: #00691e; }
        .status-out { background-color: #ffd1d1; color: #d70015; }
        .status-return { background-color: #cce5ff; color: #004085; }
        .alert { padding: 16px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; font-weight: 500; border: 1px solid transparent; }
        .alert-success { background-color: var(--primary-light-color); color: var(--primary-color); border-color: var(--primary-color); }
        .alert-warning { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translate(-50%, 200%); background-color: var(--text-color); color: white; padding: 14px 22px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: 500; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1000; }
        .toast.show { transform: translate(-50%, 0); }
        .footer-by-osmaweb { text-align: center; font-size: 0.8rem; color: var(--text-light-color); margin-top: 40px; padding-bottom: 20px; }
        .stock-display { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .stock-display .total { font-weight: 600; font-size: 1.1rem; }
        .stock-display .breakdown { font-size: 0.85rem; color: var(--text-light-color); }

        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: var(--border-radius); width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.5rem; font-weight: 600; }
        .close { font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        .close:hover { color: #000; }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .container { padding: 16px; }
            .header h1 { font-size: 2rem; }
            .header h2 { font-size: 1rem; }
            .card { padding: 16px 20px; }
            .nav-tabs { gap: 4px; padding-bottom: 0; }
            .nav-tab { padding: 10px 12px; font-size: 0.9rem; }
            
            /* Dashboard Grid - Mobile */
            .dashboard-grid { grid-template-columns: 1fr; gap: 16px; }
            .low-stock-card { padding: 16px; }
            .low-stock-card .stock { font-size: 2rem; }
            
            /* Form layouts - Mobile */
            .wine-entry { grid-template-columns: 1fr; gap: 12px; }
            .remove-btn { margin-top: 0; height: auto; padding: 8px 16px; width: 100%; }
            
            .form-actions { flex-direction: column; }
            .form-actions .btn { width: 100%; }
            
            .table-controls { flex-direction: column; align-items: stretch; gap: 12px; }
            .sort-controls { justify-content: space-between; }
            
            /* Tables - Mobile Card Layout */
            .mobile-table { display: none; }
            table { display: none; }
            .mobile-cards { display: block; }
            .mobile-card { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--border-color); }
            .mobile-card-header { font-weight: 600; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: flex-start; }
            .mobile-card-content { display: flex; flex-direction: column; gap: 4px; }
            .mobile-card-row { display: flex; justify-content: space-between; font-size: 0.9rem; }
            .mobile-card-row .label { color: var(--text-light-color); }
            .mobile-card-actions { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }
            .mobile-card-actions .btn { flex: 1; min-width: auto; }
        }

        @media (max-width: 480px) {
            .header h1 { font-size: 1.5rem; }
            .card { padding: 12px 16px; }
            .nav-tab { padding: 8px 10px; font-size: 0.8rem; }
            .low-stock-card .stock { font-size: 1.5rem; }
            .modal-content { margin: 2% auto; width: 95%; }
        }

        /* Desktop table visibility */
        @media (min-width: 769px) {
            .mobile-cards { display: none; }
            table { display: table; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Gestion de Stock</h1>
            <h2>La Boutique Concept</h2>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">📊 Tableau de bord</button>
            <button class="nav-tab" data-tab="transactions">📝 Transactions</button>
            <button class="nav-tab" data-tab="catalog">🍷 Catalogue</button>
            <button class="nav-tab" data-tab="analysis">📈 Analyse</button>
            <button class="nav-tab" data-tab="settings">⚙️ Paramètres</button>
        </nav>

        <div id="dashboard" class="tab-content active">
            <div class="dashboard-grid" id="lowStockDashboard"></div>
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Inventaire Détaillé</h2>
                </div>
                <div class="table-controls">
                    <div class="sort-controls">
                        <label for="inventorySort">Trier par :</label>
                        <select class="form-control" id="inventorySort" style="width: auto; min-width: 150px;">
                            <option value="name">Nom (A-Z)</option>
                            <option value="name-desc">Nom (Z-A)</option>
                            <option value="type">Type</option>
                            <option value="stock">Stock (croissant)</option>
                            <option value="stock-desc">Stock (décroissant)</option>
                        </select>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Vin</th>
                            <th>Stock Caisses</th>
                            <th>Stock Bouteilles</th>
                            <th>Total Bouteilles</th>
                        </tr>
                    </thead>
                    <tbody id="detailedInventory"></tbody>
                </table>
                <div class="mobile-cards" id="detailedInventoryMobile"></div>
            </div>
            <div class="card">
                <div class="card-header"><h2 class="card-title">Transaction Rapide</h2></div>
                <form id="quickForm">
                     <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; align-items:flex-start;">
                        <div class="form-group"><label class="form-label" for="quickType">Type</label><select class="form-control" id="quickType" name="quickType" required><option value="">Sélectionner...</option><option value="entree">📥 Entrée</option><option value="sortie">📤 Sortie</option><option value="retour">↩️ Retour</option></select></div>
                        <div class="form-group"><label class="form-label" for="quickWine">Vin</label><select class="form-control wine-select" id="quickWine" name="quickWine" required></select></div>
                        <div class="form-group"><label class="form-label" for="quickQtyCases">Qté (Caisses)</label><input type="number" class="form-control" id="quickQtyCases" name="quickQtyCases" min="0" placeholder="0"></div>
                        <div class="form-group"><label class="form-label" for="quickQtyBottles">Qté (Bouteilles)</label><input type="number" class="form-control" id="quickQtyBottles" name="quickQtyBottles" min="0" placeholder="0"><div class="stock-validator" id="quickStockValidator"></div></div>
                    </div>
                    <div class="form-actions"><button type="submit" class="btn btn-primary">Valider la Transaction</button></div>
                </form>
            </div>
        </div>

        <div id="transactions" class="tab-content">
            <div class="card">
                <div class="card-header"><h2 class="card-title">Nouvelle Transaction</h2></div>
                <form id="transactionForm">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div class="form-group"><label class="form-label" for="date">Date</label><input type="date" class="form-control" id="date" name="date" required></div>
                        <div class="form-group"><label class="form-label" for="type">Type</label><select class="form-control" id="type" name="type" required><option value="">Sélectionner...</option><option value="entree">📥 Entrée</option><option value="sortie">📤 Sortie</option><option value="retour">↩️ Retour</option></select></div>
                        <div class="form-group"><label class="form-label" for="reference">Référence</label><input type="text" class="form-control" id="reference" name="reference" placeholder="Ex: Mariage Dupont"></div>
                    </div>
                    <div class="wine-entries" id="wineEntries"></div>
                    <div class="form-actions"><button type="button" class="btn btn-secondary" id="addWineBtn">+ Ajouter un vin</button><button type="submit" class="btn btn-primary">Enregistrer la Transaction</button></div>
                </form>
            </div>
            <div class="card">
                <div class="card-header"><h2 class="card-title">Historique des Transactions</h2></div>
                <input type="search" class="form-control" id="searchInput" placeholder="Rechercher une transaction..." style="max-width: 400px; margin-bottom: 20px;">
                <table><thead><tr><th>Date</th><th>Type</th><th>Vins (Qté Bouteilles)</th><th>Référence</th><th>Actions</th></tr></thead><tbody id="transactionsTable"></tbody></table>
                <div class="mobile-cards" id="transactionsTableMobile"></div>
            </div>
        </div>

        <div id="catalog" class="tab-content">
            <div class="card">
                <div class="card-header"><h2 class="card-title">Ajouter un Vin au Catalogue</h2></div>
                <form id="addWineForm" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 16px; align-items: flex-end;">
                    <div class="form-group" style="margin-bottom:0;"><label class="form-label" for="wineName">Nom du Vin</label><input type="text" class="form-control" id="wineName" required></div>
                    <div class="form-group" style="margin-bottom:0;"><label class="form-label" for="wineType">Type</label><select class="form-control" id="wineType" required><option value="">Sélectionner...</option><option value="rouge">Rouge</option><option value="blanc">Blanc</option><option value="rose">Rosé</option><option value="champagne">Champagne</option></select></div>
                    <div class="form-group" style="margin-bottom:0;"><label class="form-label" for="bottlesPerCase">Bouteilles / caisse</label><input type="number" class="form-control" id="bottlesPerCase" min="1" required placeholder="Ex: 6"></div>
                    <button type="submit" class="btn btn-primary" style="height:45px;">Ajouter</button>
                </form>
            </div>
             <div class="card">
                <div class="card-header"><h2 class="card-title">Vins au Catalogue</h2></div>
                <div class="table-controls">
                    <input type="search" class="form-control" id="wineSearch" placeholder="Rechercher un vin..." style="max-width: 400px;">
                    <div class="sort-controls">
                        <label for="catalogSort">Trier par :</label>
                        <select class="form-control" id="catalogSort" style="width: auto; min-width: 150px;">
                            <option value="name">Nom (A-Z)</option>
                            <option value="name-desc">Nom (Z-A)</option>
                            <option value="type">Type</option>
                        </select>
                    </div>
                </div>
                <table><thead><tr><th>Nom</th><th>Type</th><th>Bouteilles / Caisse</th><th>Action</th></tr></thead><tbody id="wineList"></tbody></table>
                <div class="mobile-cards" id="wineListMobile"></div>
             </div>
        </div>

        <div id="analysis" class="tab-content">
             <div class="card">
                <div class="card-header"><h2 class="card-title">Analyse des Consommations et Retours</h2></div>
                <div class="table-controls">
                    <div class="sort-controls">
                        <label for="analysisSort">Trier par :</label>
                        <select class="form-control" id="analysisSort" style="width: auto; min-width: 180px;">
                            <option value="name">Nom (A-Z)</option>
                            <option value="consumption">Consommation (décroissant)</option>
                            <option value="returns">Retours (décroissant)</option>
                            <option value="rate">Taux de retour (décroissant)</option>
                        </select>
                    </div>
                </div>
                <table><thead><tr><th>Vin</th><th>Total Sorties</th><th>Total Retours</th><th>Consommation Nette</th><th>Taux de Retour</th></tr></thead><tbody id="analysisTable"></tbody></table>
                <div class="mobile-cards" id="analysisTableMobile"></div>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <div class="card">
                <div class="card-header"><h2 class="card-title">Paramètres Généraux</h2></div>
                <div class="form-group" style="max-width:300px;"><label class="form-label" for="threshold">Seuil d'alerte (bouteilles restantes)</label><input type="number" class="form-control" id="threshold" value="12" min="0"></div>
                <div class="form-actions"><button class="btn btn-secondary" onclick="exportData()">📊 Exporter (CSV)</button><button class="btn btn-secondary" onclick="printInventory()">🖨️ Imprimer l'Inventaire</button></div>
            </div>
        </div>
    </div>

    <!-- Modal pour modifier une transaction -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Modifier la Transaction</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="editTransactionForm">
                <input type="hidden" id="editTransactionId">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div class="form-group"><label class="form-label" for="editDate">Date</label><input type="date" class="form-control" id="editDate" name="editDate" required></div>
                    <div class="form-group"><label class="form-label" for="editType">Type</label><select class="form-control" id="editType" name="editType" required><option value="entree">📥 Entrée</option><option value="sortie">📤 Sortie</option><option value="retour">↩️ Retour</option></select></div>
                    <div class="form-group"><label class="form-label" for="editReference">Référence</label><input type="text" class="form-control" id="editReference" name="editReference" placeholder="Ex: Mariage Dupont"></div>
                </div>
                <div class="wine-entries" id="editWineEntries"></div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="editAddWineBtn">+ Ajouter un vin</button>
                    <button type="submit" class="btn btn-primary">Sauvegarder les Modifications</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="toast"><span id="toastMsg"></span></div>
    <div class="footer-by-osmaweb">Conçu et développé par Osmaweb.</div>

<script>
// ===================================================================================
// CONFIGURATION SUPABASE
// ===================================================================================
const SUPABASE_URL = "https://jvthgikhwaxiqxsjmacl.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dGhnaWtod2F4aXF4c2ptYWNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzNDg4MjMsImV4cCI6MjA2NDkyNDgyM30.f5ixqtktLbDRPT2IyJodmMBbYD2ZK7TRfCNszz2nM48";

const apiHeaders = {
    'apikey': SUPABASE_KEY,
    'Authorization': `Bearer ${SUPABASE_KEY}`,
    'Content-Type': 'application/json',
    'Prefer': 'return=representation'
};

// ===================================================================================
// ÉTAT DE L'APPLICATION
// ===================================================================================
let state = {
    wines: [],
    transactions: [],
    threshold: 12,
    editingTransaction: null
};

// ===================================================================================
// INITIALISATION
// ===================================================================================
document.addEventListener('DOMContentLoaded', () => {
    initApp();
});

async function initApp() {
    initEventListeners();
    addWineEntry();
    showToast('Connexion à la base de données...');

    await loadDataFromSupabase();
    updateAll();
    showToast('Application prête !');
}

function initEventListeners() {
    document.querySelectorAll('.nav-tab').forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
    document.getElementById('quickForm').addEventListener('submit', handleQuickTransaction);
    document.getElementById('transactionForm').addEventListener('submit', handleTransaction);
    document.getElementById('editTransactionForm').addEventListener('submit', handleEditTransaction);
    document.getElementById('addWineForm').addEventListener('submit', handleAddWine);
    document.getElementById('addWineBtn').addEventListener('click', () => addWineEntry());
    document.getElementById('editAddWineBtn').addEventListener('click', () => addWineEntry('editWineEntries'));
    document.getElementById('searchInput').addEventListener('input', updateTransactionsTable);
    document.getElementById('wineSearch').addEventListener('input', updateWineList);
    document.getElementById('threshold').addEventListener('change', e => { state.threshold = parseInt(e.target.value) || 0; updateDashboard(); });
    document.getElementById('date').valueAsDate = new Date();
    
    document.getElementById('inventorySort').addEventListener('change', updateDashboard);
    document.getElementById('catalogSort').addEventListener('change', updateWineList);
    document.getElementById('analysisSort').addEventListener('change', updateAnalysisTable);
    
    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
        const modal = document.getElementById('editTransactionModal');
        if (e.target === modal) {
            closeEditModal();
        }
    });
    
    initRealTimeValidation();
}

// ===================================================================================
// COMMUNICATION AVEC SUPABASE
// ===================================================================================
async function loadDataFromSupabase() {
    try {
        const [winesRes, transactionsRes] = await Promise.all([
            fetch(`${SUPABASE_URL}/rest/v1/wines?select=*`, { headers: apiHeaders }),
            fetch(`${SUPABASE_URL}/rest/v1/transactions?select=*&order=created_at.desc`, { headers: apiHeaders })
        ]);
        if (!winesRes.ok || !transactionsRes.ok) throw new Error("Erreur réseau ou permissions (Vérifiez la sécurité RLS sur Supabase)");
        state.wines = await winesRes.json();
        state.transactions = await transactionsRes.json();
    } catch (error) {
        console.error("Erreur de chargement:", error);
        showToast("Erreur: Impossible de charger les données.");
    }
}

async function handleAddWine(e) {
    e.preventDefault();
    setFormDisabled(true);
    const name = document.getElementById('wineName').value.trim();
    const type = document.getElementById('wineType').value;
    const bottlesPerCase = parseInt(document.getElementById('bottlesPerCase').value);
    if (!name || !type || !bottlesPerCase) { showToast('⚠️ Veuillez remplir tous les champs.'); setFormDisabled(false); return; }
    if (state.wines.some(w => w.name.toLowerCase() === name.toLowerCase())) { showToast('⚠️ Ce nom de vin existe déjà.'); setFormDisabled(false); return; }
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/wines`, { 
            method: 'POST', 
            headers: apiHeaders, 
            body: JSON.stringify({ 
                name, 
                type, 
                bottles_per_case: bottlesPerCase, 
                stock_cases: 0, 
                stock_bottles: 0 
            }) 
        });
        if (!response.ok) throw new Error('Échec de la création du vin.');
        const newWine = await response.json();
        state.wines.push(newWine[0]);
        e.target.reset();
        updateAll();
        showToast('🍷 Vin ajouté au catalogue');
    } catch (error) { showToast("Erreur lors de l'ajout du vin."); console.error(error); }
    setFormDisabled(false);
}

async function handleQuickTransaction(e) { e.preventDefault(); await processTransaction(new FormData(e.target), 'quick'); }
async function handleTransaction(e) { e.preventDefault(); await processTransaction(new FormData(e.target), 'detailed'); }

// Fonctions utilitaires pour gérer la compatibilité des stocks
function getWineStockInfo(wine) {
    if (wine.stock_cases !== undefined || wine.stock_bottles !== undefined) {
        const cases = wine.stock_cases || 0;
        const bottles = wine.stock_bottles || 0;
        return {
            cases: cases,
            bottles: bottles,
            total: cases * wine.bottles_per_case + bottles
        };
    }
    const totalStock = wine.stock || 0;
    const cases = Math.floor(totalStock / wine.bottles_per_case);
    const bottles = totalStock % wine.bottles_per_case;
    return {
        cases: cases,
        bottles: bottles,
        total: totalStock
    };
}

async function processTransaction(formData, formType) {
    setFormDisabled(true);
    const type = formData.get(formType === 'quick' ? 'quickType' : 'type');
    const reference = formData.get('reference') || 'Transaction rapide';
    const date = formData.get('date') || new Date().toISOString().split('T')[0];
    let winesInTx = [], stockCheckFailed = false;

    if (formType === 'quick') {
        const wineId = parseInt(formData.get('quickWine')), cases = parseInt(formData.get('quickQtyCases')) || 0, bottles = parseInt(formData.get('quickQtyBottles')) || 0;
        const wine = state.wines.find(w => w.id === wineId);
        if (wine && (cases > 0 || bottles > 0)) {
            const stockInfo = getWineStockInfo(wine);
            const quantity = (cases * wine.bottles_per_case) + bottles;
            if (type === 'sortie' && stockInfo.total < quantity) stockCheckFailed = true;
            winesInTx.push({ ...wine, transaction_cases: cases, transaction_bottles: bottles, quantity, currentStock: stockInfo });
        }
    } else {
        document.querySelectorAll('#wineEntries .wine-entry').forEach(entry => {
            const wineId = parseInt(entry.querySelector('.wine-select').value), cases = parseInt(entry.querySelector('.wine-cases').value) || 0, bottles = parseInt(entry.querySelector('.wine-bottles').value) || 0;
            const wine = state.wines.find(w => w.id === wineId);
            if(wine && (cases > 0 || bottles > 0)) {
                const stockInfo = getWineStockInfo(wine);
                const quantity = (cases * wine.bottles_per_case) + bottles;
                if (type === 'sortie' && stockInfo.total < quantity) stockCheckFailed = true;
                winesInTx.push({ ...wine, transaction_cases: cases, transaction_bottles: bottles, quantity, currentStock: stockInfo });
            }
        });
    }

    if (!type) { showToast('⚠️ Veuillez sélectionner un type.'); setFormDisabled(false); return; }
    if (winesInTx.length === 0) { showToast('⚠️ Veuillez ajouter au moins un vin.'); setFormDisabled(false); return; }
    if (stockCheckFailed) { showToast('⚠️ Stock insuffisant.'); setFormDisabled(false); return; }
    
    const multiplier = type === 'sortie' ? -1 : 1;
    const stockUpdatePromises = winesInTx.map(txWine => {
        const newCases = txWine.currentStock.cases + (txWine.transaction_cases * multiplier);
        const newBottles = txWine.currentStock.bottles + (txWine.transaction_bottles * multiplier);
        
        return fetch(`${SUPABASE_URL}/rest/v1/wines?id=eq.${txWine.id}`, { 
            method: 'PATCH', 
            headers: apiHeaders, 
            body: JSON.stringify({ 
                stock_cases: Math.max(0, newCases),
                stock_bottles: Math.max(0, newBottles)
            }) 
        });
    });

    try {
        const stockUpdateResponses = await Promise.all(stockUpdatePromises);
        stockUpdateResponses.forEach(res => { if (!res.ok) throw new Error('Échec mise à jour stock.'); });
        const wines_involved = winesInTx.map(w => ({ 
            id: w.id, 
            name: w.name, 
            cases: w.transaction_cases,
            bottles: w.transaction_bottles,
            quantity: w.quantity 
        }));
        const txResponse = await fetch(`${SUPABASE_URL}/rest/v1/transactions`, { method: 'POST', headers: apiHeaders, body: JSON.stringify({ date, type, reference, wines_involved }) });
        if (!txResponse.ok) throw new Error('Échec enregistrement transaction.');
        await loadDataFromSupabase();
        if (formType === 'quick') document.getElementById('quickForm').reset(); else resetTransactionForm();
        updateAll();
        showToast('✅ Transaction enregistrée.');
    } catch (error) { showToast("Erreur lors de la transaction."); console.error(error); }
    setFormDisabled(false);
}

// ===================================================================================
// GESTION DE LA MODIFICATION DES TRANSACTIONS
// ===================================================================================
function openEditModal(transactionId) {
    const transaction = state.transactions.find(t => t.id === transactionId);
    if (!transaction) return;
    
    state.editingTransaction = transaction;
    
    // Remplir les champs de base
    document.getElementById('editTransactionId').value = transaction.id;
    document.getElementById('editDate').value = transaction.date;
    document.getElementById('editType').value = transaction.type;
    document.getElementById('editReference').value = transaction.reference || '';
    
    // Vider les entrées de vins existantes
    document.getElementById('editWineEntries').innerHTML = '';
    
    // Ajouter les vins de la transaction
    (transaction.wines_involved || []).forEach(wine => {
        addWineEntry('editWineEntries');
        const entries = document.querySelectorAll('#editWineEntries .wine-entry');
        const lastEntry = entries[entries.length - 1];
        
        lastEntry.querySelector('.wine-select').value = wine.id;
        lastEntry.querySelector('.wine-cases').value = wine.cases || 0;
        lastEntry.querySelector('.wine-bottles').value = wine.bottles || 0;
    });
    
    // Si aucun vin, ajouter une entrée vide
    if ((transaction.wines_involved || []).length === 0) {
        addWineEntry('editWineEntries');
    }
    
    updateWineSelects();
    document.getElementById('editTransactionModal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editTransactionModal').style.display = 'none';
    state.editingTransaction = null;
}

async function handleEditTransaction(e) {
    e.preventDefault();
    if (!state.editingTransaction) return;
    
    setFormDisabled(true);
    
    const formData = new FormData(e.target);
    const transactionId = parseInt(document.getElementById('editTransactionId').value);
    const newType = formData.get('editType');
    const newReference = formData.get('editReference') || '';
    const newDate = formData.get('editDate');
    
    // Collecter les nouveaux vins
    let newWinesInTx = [];
    document.querySelectorAll('#editWineEntries .wine-entry').forEach(entry => {
        const wineId = parseInt(entry.querySelector('.wine-select').value);
        const cases = parseInt(entry.querySelector('.wine-cases').value) || 0;
        const bottles = parseInt(entry.querySelector('.wine-bottles').value) || 0;
        const wine = state.wines.find(w => w.id === wineId);
        
        if (wine && (cases > 0 || bottles > 0)) {
            const quantity = (cases * wine.bottles_per_case) + bottles;
            newWinesInTx.push({
                ...wine,
                transaction_cases: cases,
                transaction_bottles: bottles,
                quantity
            });
        }
    });
    
    if (newWinesInTx.length === 0) {
        showToast('⚠️ Veuillez ajouter au moins un vin.');
        setFormDisabled(false);
        return;
    }
    
    try {
        // Étape 1: Restaurer l'ancien stock
        const oldTransaction = state.editingTransaction;
        const oldMultiplier = oldTransaction.type === 'sortie' ? 1 : -1;
        
        const restoreStockPromises = (oldTransaction.wines_involved || []).map(oldWine => {
            const wineInState = state.wines.find(w => w.id === oldWine.id);
            if (!wineInState) return Promise.resolve();
            
            const stockInfo = getWineStockInfo(wineInState);
            const restoredCases = stockInfo.cases + ((oldWine.cases || 0) * oldMultiplier);
            const restoredBottles = stockInfo.bottles + ((oldWine.bottles || 0) * oldMultiplier);
            
            return fetch(`${SUPABASE_URL}/rest/v1/wines?id=eq.${oldWine.id}`, {
                method: 'PATCH',
                headers: apiHeaders,
                body: JSON.stringify({
                    stock_cases: Math.max(0, restoredCases),
                    stock_bottles: Math.max(0, restoredBottles)
                })
            });
        });
        
        await Promise.all(restoreStockPromises);
        
        // Recharger les données pour avoir les stocks restaurés
        await loadDataFromSupabase();
        
        // Étape 2: Vérifier la disponibilité du stock pour la nouvelle transaction
        let stockCheckFailed = false;
        if (newType === 'sortie') {
            for (const txWine of newWinesInTx) {
                const wine = state.wines.find(w => w.id === txWine.id);
                const stockInfo = getWineStockInfo(wine);
                if (stockInfo.total < txWine.quantity) {
                    stockCheckFailed = true;
                    break;
                }
            }
        }
        
        if (stockCheckFailed) {
            // Restaurer l'ancienne transaction si le stock est insuffisant
            const revertMultiplier = oldTransaction.type === 'sortie' ? -1 : 1;
            const revertPromises = (oldTransaction.wines_involved || []).map(oldWine => {
                const wineInState = state.wines.find(w => w.id === oldWine.id);
                if (!wineInState) return Promise.resolve();
                
                const stockInfo = getWineStockInfo(wineInState);
                const revertedCases = stockInfo.cases + ((oldWine.cases || 0) * revertMultiplier);
                const revertedBottles = stockInfo.bottles + ((oldWine.bottles || 0) * revertMultiplier);
                
                return fetch(`${SUPABASE_URL}/rest/v1/wines?id=eq.${oldWine.id}`, {
                    method: 'PATCH',
                    headers: apiHeaders,
                    body: JSON.stringify({
                        stock_cases: Math.max(0, revertedCases),
                        stock_bottles: Math.max(0, revertedBottles)
                    })
                });
            });
            
            await Promise.all(revertPromises);
            showToast('⚠️ Stock insuffisant pour la modification.');
            setFormDisabled(false);
            return;
        }
        
        // Étape 3: Appliquer le nouveau stock
        const newMultiplier = newType === 'sortie' ? -1 : 1;
        const applyStockPromises = newWinesInTx.map(txWine => {
            const wine = state.wines.find(w => w.id === txWine.id);
            const stockInfo = getWineStockInfo(wine);
            const newCases = stockInfo.cases + (txWine.transaction_cases * newMultiplier);
            const newBottles = stockInfo.bottles + (txWine.transaction_bottles * newMultiplier);
            
            return fetch(`${SUPABASE_URL}/rest/v1/wines?id=eq.${txWine.id}`, {
                method: 'PATCH',
                headers: apiHeaders,
                body: JSON.stringify({
                    stock_cases: Math.max(0, newCases),
                    stock_bottles: Math.max(0, newBottles)
                })
            });
        });
        
        await Promise.all(applyStockPromises);
        
        // Étape 4: Mettre à jour la transaction
        const wines_involved = newWinesInTx.map(w => ({
            id: w.id,
            name: w.name,
            cases: w.transaction_cases,
            bottles: w.transaction_bottles,
            quantity: w.quantity
        }));
        
        const updateResponse = await fetch(`${SUPABASE_URL}/rest/v1/transactions?id=eq.${transactionId}`, {
            method: 'PATCH',
            headers: apiHeaders,
            body: JSON.stringify({
                date: newDate,
                type: newType,
                reference: newReference,
                wines_involved
            })
        });
        
        if (!updateResponse.ok) throw new Error('Échec de la mise à jour de la transaction.');
        
        await loadDataFromSupabase();
        updateAll();
        closeEditModal();
        showToast('✅ Transaction modifiée avec succès.');
        
    } catch (error) {
        console.error('Erreur lors de la modification:', error);
        showToast('Erreur lors de la modification de la transaction.');
    }
    
    setFormDisabled(false);
}

async function deleteWine(id) {
    if (state.transactions.some(t => (t.wines_involved || []).some(w => w.id === id))) return showToast('⚠️ Impossible : vin utilisé dans des transactions.');
    if (!confirm('Voulez-vous vraiment supprimer ce vin ?')) return;
    setFormDisabled(true);
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/wines?id=eq.${id}`, { method: 'DELETE', headers: apiHeaders });
        if (!response.ok) throw new Error('Échec suppression.');
        state.wines = state.wines.filter(w => w.id !== id);
        updateAll();
        showToast('🗑️ Vin supprimé.');
    } catch (error) { showToast("Erreur lors de la suppression."); }
    setFormDisabled(false);
}

async function deleteTransaction(id) {
    if (!confirm('Voulez-vous supprimer cette transaction ? Le stock sera recalculé.')) return;
    setFormDisabled(true);
    const tx = state.transactions.find(t => t.id === id);
    if (!tx) return setFormDisabled(false);
    const multiplier = tx.type === 'sortie' ? 1 : -1;
    const stockUpdatePromises = (tx.wines_involved || []).map(txWine => {
        const wineInState = state.wines.find(w => w.id === txWine.id);
        if (!wineInState) return Promise.resolve();
        
        const stockInfo = getWineStockInfo(wineInState);
        const newCases = stockInfo.cases + ((txWine.cases || 0) * multiplier);
        const newBottles = stockInfo.bottles + ((txWine.bottles || 0) * multiplier);
        
        return fetch(`${SUPABASE_URL}/rest/v1/wines?id=eq.${txWine.id}`, { 
            method: 'PATCH', 
            headers: apiHeaders, 
            body: JSON.stringify({ 
                stock_cases: Math.max(0, newCases),
                stock_bottles: Math.max(0, newBottles)
            }) 
        });
    });
    try {
        await Promise.all(stockUpdatePromises);
        const deleteTxResponse = await fetch(`${SUPABASE_URL}/rest/v1/transactions?id=eq.${id}`, { method: 'DELETE', headers: apiHeaders });
        if (!deleteTxResponse.ok) throw new Error('Échec suppression transaction.');
        await loadDataFromSupabase();
        updateAll();
        showToast('🗑️ Transaction supprimée.');
    } catch(error) { showToast("Erreur lors de l'annulation."); console.error(error); }
    setFormDisabled(false);
}

function getSortedWines(wines, sortType) {
    const winesCopy = [...wines];
    
    switch(sortType) {
        case 'name':
            return winesCopy.sort((a, b) => a.name.localeCompare(b.name));
        case 'name-desc':
            return winesCopy.sort((a, b) => b.name.localeCompare(a.name));
        case 'type':
            return winesCopy.sort((a, b) => {
                if (a.type === b.type) return a.name.localeCompare(b.name);
                return a.type.localeCompare(b.type);
            });
        case 'stock':
            return winesCopy.sort((a, b) => {
                const stockA = getWineStockInfo(a).total;
                const stockB = getWineStockInfo(b).total;
                return stockA - stockB;
            });
        case 'stock-desc':
            return winesCopy.sort((a, b) => {
                const stockA = getWineStockInfo(a).total;
                const stockB = getWineStockInfo(b).total;
                return stockB - stockA;
            });
        default:
            return winesCopy;
    }
}

function updateDashboard() {
    const dashboardContainer = document.getElementById('lowStockDashboard');
    if (state.wines.length === 0) { 
        dashboardContainer.innerHTML = '<div class="alert alert-success" style="grid-column: 1 / -1;">Commencez par ajouter des vins à votre catalogue.</div>'; 
    } else {
        const winesWithStock = state.wines.map(wine => {
            const stockInfo = getWineStockInfo(wine);
            return {
                ...wine,
                totalStock: stockInfo.total
            };
        });
        
        const lowStockWines = winesWithStock.sort((a, b) => a.totalStock - b.totalStock).slice(0, 4);
        dashboardContainer.innerHTML = lowStockWines.map(wine => {
            let stockClass = '';
            if (wine.totalStock <= state.threshold) stockClass = 'critical';
            else if (wine.totalStock <= state.threshold * 2) stockClass = 'warning';
            return `<div class="low-stock-card"><div class="info"><span class="name">${wine.name}</span><span class="type-badge badge-${wine.type}">${wine.type}</span></div><div class="stock ${stockClass}">${wine.totalStock}</div></div>`;
        }).join('');
    }
    
    // Update desktop table
    const inventoryBody = document.getElementById('detailedInventory');
    const sortType = document.getElementById('inventorySort').value;
    
    if (state.wines.length === 0) { 
        inventoryBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 40px;">Votre inventaire est vide.</td></tr>'; 
    } else { 
        const sortedWines = getSortedWines(state.wines, sortType);
        inventoryBody.innerHTML = sortedWines.map(wine => { 
            const stockInfo = getWineStockInfo(wine);
            
            return `<tr>
                <td>${getWineEmoji(wine.type)} ${wine.name}</td>
                <td><strong>${stockInfo.cases}</strong></td>
                <td><strong>${stockInfo.bottles}</strong></td>
                <td><strong>${stockInfo.total}</strong></td>
            </tr>`; 
        }).join(''); 
    }
    
    // Update mobile cards
    const inventoryMobile = document.getElementById('detailedInventoryMobile');
    if (state.wines.length === 0) {
        inventoryMobile.innerHTML = '<div class="alert alert-success">Votre inventaire est vide.</div>';
    } else {
        const sortedWines = getSortedWines(state.wines, sortType);
        inventoryMobile.innerHTML = sortedWines.map(wine => {
            const stockInfo = getWineStockInfo(wine);
            return `
                <div class="mobile-card">
                    <div class="mobile-card-header">
                        <span><strong>${getWineEmoji(wine.type)} ${wine.name}</strong></span>
                        <span class="type-badge badge-${wine.type}">${wine.type}</span>
                    </div>
                    <div class="mobile-card-content">
                        <div class="mobile-card-row">
                            <span class="label">Stock Caisses:</span>
                            <span><strong>${stockInfo.cases}</strong></span>
                        </div>
                        <div class="mobile-card-row">
                            <span class="label">Stock Bouteilles:</span>
                            <span><strong>${stockInfo.bottles}</strong></span>
                        </div>
                        <div class="mobile-card-row">
                            <span class="label">Total Bouteilles:</span>
                            <span><strong>${stockInfo.total}</strong></span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function updateTransactionsTable() {
    const tbody = document.getElementById('transactionsTable');
    const mobileContainer = document.getElementById('transactionsTableMobile');
    const search = document.getElementById('searchInput').value.toLowerCase();
    const filtered = state.transactions.filter(t => (t.date + t.reference + (t.wines_involved || []).map(w => w.name).join(' ')).toLowerCase().includes(search));
    
    if (filtered.length === 0) { 
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px;">Aucune transaction trouvée.</td></tr>';
        mobileContainer.innerHTML = '<div class="alert alert-success">Aucune transaction trouvée.</div>';
        return; 
    }
    
    // Desktop table
    tbody.innerHTML = filtered.map(t => `<tr><td>${new Date(t.date).toLocaleDateString('fr-FR')}</td><td><span class="status-badge status-${{entree:'in', sortie:'out', retour:'return'}[t.type]}">${t.type}</span></td><td>${(t.wines_involved || []).map(w => {
        let qtyDisplay = '';
        if (w.cases && w.bottles) {
            qtyDisplay = `${w.cases}c + ${w.bottles}b`;
        } else if (w.cases) {
            qtyDisplay = `${w.cases}c`;
        } else if (w.bottles) {
            qtyDisplay = `${w.bottles}b`;
        } else {
            qtyDisplay = `${w.quantity || 0}b`;
        }
        return `${w.name} (${qtyDisplay})`;
    }).join(', ')}</td><td>${t.reference || 'N/A'}</td><td><button class="btn btn-secondary btn-small" onclick="openEditModal(${t.id})" style="margin-right: 8px;">Modifier</button><button class="btn btn-danger btn-small" onclick="deleteTransaction(${t.id})">Supprimer</button></td></tr>`).join('');

    // Mobile cards
    mobileContainer.innerHTML = filtered.map(t => {
        const winesDisplay = (t.wines_involved || []).map(w => {
            let qtyDisplay = '';
            if (w.cases && w.bottles) {
                qtyDisplay = `${w.cases}c + ${w.bottles}b`;
            } else if (w.cases) {
                qtyDisplay = `${w.cases}c`;
            } else if (w.bottles) {
                qtyDisplay = `${w.bottles}b`;
            } else {
                qtyDisplay = `${w.quantity || 0}b`;
            }
            return `${w.name} (${qtyDisplay})`;
        }).join(', ');
        
        return `
            <div class="mobile-card">
                <div class="mobile-card-header">
                    <span><strong>${new Date(t.date).toLocaleDateString('fr-FR')}</strong></span>
                    <span class="status-badge status-${{entree:'in', sortie:'out', retour:'return'}[t.type]}">${t.type}</span>
                </div>
                <div class="mobile-card-content">
                    <div class="mobile-card-row">
                        <span class="label">Vins:</span>
                        <span>${winesDisplay}</span>
                    </div>
                    <div class="mobile-card-row">
                        <span class="label">Référence:</span>
                        <span>${t.reference || 'N/A'}</span>
                    </div>
                </div>
                <div class="mobile-card-actions">
                    <button class="btn btn-secondary btn-small" onclick="openEditModal(${t.id})">Modifier</button>
                    <button class="btn btn-danger btn-small" onclick="deleteTransaction(${t.id})">Supprimer</button>
                </div>
            </div>
        `;
    }).join('');
}

function updateWineList() {
    const tbody = document.getElementById('wineList');
    const mobileContainer = document.getElementById('wineListMobile');
    const search = document.getElementById('wineSearch').value.toLowerCase();
    const sortType = document.getElementById('catalogSort').value;
    const filtered = state.wines.filter(w => w.name.toLowerCase().includes(search));
    
    if (filtered.length === 0) { 
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 40px;">Aucun vin ne correspond à votre recherche.</td></tr>';
        mobileContainer.innerHTML = '<div class="alert alert-success">Aucun vin ne correspond à votre recherche.</div>';
        return; 
    }
    
    const sortedWines = getSortedWines(filtered, sortType);
    
    // Desktop table
    tbody.innerHTML = sortedWines.map(wine => `<tr><td>${getWineEmoji(wine.type)} ${wine.name}</td><td><span class="type-badge badge-${wine.type}">${wine.type}</span></td><td>${wine.bottles_per_case}</td><td><button class="btn btn-danger btn-small" onclick="deleteWine(${wine.id})">Supprimer</button></td></tr>`).join('');

    // Mobile cards
    mobileContainer.innerHTML = sortedWines.map(wine => `
        <div class="mobile-card">
            <div class="mobile-card-header">
                <span><strong>${getWineEmoji(wine.type)} ${wine.name}</strong></span>
                <span class="type-badge badge-${wine.type}">${wine.type}</span>
            </div>
            <div class="mobile-card-content">
                <div class="mobile-card-row">
                    <span class="label">Bouteilles / Caisse:</span>
                    <span>${wine.bottles_per_case}</span>
                </div>
            </div>
            <div class="mobile-card-actions">
                <button class="btn btn-danger btn-small" onclick="deleteWine(${wine.id})">Supprimer</button>
            </div>
        </div>
    `).join('');
}

function updateAnalysisTable() {
    const tbody = document.getElementById('analysisTable');
    const mobileContainer = document.getElementById('analysisTableMobile');
    const sortType = document.getElementById('analysisSort').value;
    
    if (state.wines.length === 0) { 
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px;">Aucune donnée à analyser.</td></tr>';
        mobileContainer.innerHTML = '<div class="alert alert-success">Aucune donnée à analyser.</div>';
        return; 
    }
    
    const analysisData = state.wines.map(wine => {
        const movements = { sortie: 0, retour: 0 };
        state.transactions.forEach(t => { 
            const wineInTx = (t.wines_involved || []).find(w => w.id === wine.id); 
            if (wineInTx && movements.hasOwnProperty(t.type)) movements[t.type] += wineInTx.quantity || 0; 
        });
        const netConsumption = movements.sortie - movements.retour;
        const returnRate = movements.sortie > 0 ? ((movements.retour / movements.sortie) * 100).toFixed(1) : 0;
        return { name: wine.name, type: wine.type, ...movements, netConsumption, returnRate: parseFloat(returnRate) };
    });
    
    switch(sortType) {
        case 'consumption':
            analysisData.sort((a, b) => b.netConsumption - a.netConsumption);
            break;
        case 'returns':
            analysisData.sort((a, b) => b.retour - a.retour);
            break;
        case 'rate':
            analysisData.sort((a, b) => b.returnRate - a.returnRate);
            break;
        default:
            analysisData.sort((a, b) => a.name.localeCompare(b.name));
    }
    
    // Desktop table
    tbody.innerHTML = analysisData.map(data => `<tr><td>${getWineEmoji(data.type)} ${data.name}</td><td>${data.sortie}</td><td>${data.retour}</td><td><strong>${data.netConsumption}</strong></td><td>${data.returnRate} %</td></tr>`).join('');

    // Mobile cards
    mobileContainer.innerHTML = analysisData.map(data => `
        <div class="mobile-card">
            <div class="mobile-card-header">
                <span><strong>${getWineEmoji(data.type)} ${data.name}</strong></span>
            </div>
            <div class="mobile-card-content">
                <div class="mobile-card-row">
                    <span class="label">Total Sorties:</span>
                    <span>${data.sortie}</span>
                </div>
                <div class="mobile-card-row">
                    <span class="label">Total Retours:</span>
                    <span>${data.retour}</span>
                </div>
                <div class="mobile-card-row">
                    <span class="label">Consommation Nette:</span>
                    <span><strong>${data.netConsumption}</strong></span>
                </div>
                <div class="mobile-card-row">
                    <span class="label">Taux de Retour:</span>
                    <span>${data.returnRate} %</span>
                </div>
            </div>
        </div>
    `).join('');
}

function setFormDisabled(isDisabled) { document.querySelectorAll('button, input, select').forEach(el => el.disabled = isDisabled); }
function switchTab(tabName) { document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.querySelector(`[data-tab="${tabName}"]`).classList.add('active'); document.getElementById(tabName).classList.add('active'); const updateFn = { 'dashboard': updateDashboard, 'transactions': updateTransactionsTable, 'catalog': updateWineList, 'analysis': updateAnalysisTable }[tabName]; if (updateFn) updateFn(); }
function updateAll() { 
    updateDashboard(); updateWineSelects(); updateTransactionsTable(); updateWineList(); updateAnalysisTable(); 
}
function showToast(message) { const toast = document.getElementById('toast'); document.getElementById('toastMsg').textContent = message; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); }

function addWineEntry(containerId = 'wineEntries') { 
    const container = document.getElementById(containerId); 
    const newId = Date.now(); 
    const entryDiv = document.createElement('div'); 
    entryDiv.className = 'wine-entry'; 
    entryDiv.innerHTML = `<div class="form-group"><label class="form-label" for="wine-select-${newId}">Vin</label><select class="form-control wine-select" id="wine-select-${newId}" required></select></div><div class="form-group"><label class="form-label" for="wine-cases-${newId}">Caisses</label><input type="number" class="form-control wine-cases" id="wine-cases-${newId}" min="0" placeholder="0"></div><div class="form-group"><label class="form-label" for="wine-bottles-${newId}">Bouteilles</label><input type="number" class="form-control wine-bottles" id="wine-bottles-${newId}" min="0" placeholder="0"><div class="stock-validator"></div></div><button type="button" class="btn btn-danger remove-btn">✕</button>`; 
    container.appendChild(entryDiv); 
    updateWineSelects(); 
    entryDiv.querySelector('.remove-btn').addEventListener('click', () => entryDiv.remove()); 
}

function resetTransactionForm() { document.getElementById('transactionForm').reset(); document.getElementById('date').valueAsDate = new Date(); document.getElementById('wineEntries').innerHTML = ''; addWineEntry(); }
function getWineEmoji(type) { return { rouge: '🍷', blanc: '🥂', rose: '🌹', champagne: '🍾' }[type] || '🍇'; }

function initRealTimeValidation() { 
    const quickForm = document.getElementById('quickForm'); 
    const transactionForm = document.getElementById('transactionForm'); 
    const editForm = document.getElementById('editTransactionForm');
    
    quickForm.addEventListener('input', e => { if (['quickQtyCases', 'quickQtyBottles'].includes(e.target.id)) validateQuickForm(); }); 
    quickForm.addEventListener('change', e => { if (['quickType', 'quickWine'].includes(e.target.id)) validateQuickForm(); }); 
    
    transactionForm.addEventListener('input', e => { const entry = e.target.closest('.wine-entry'); if (entry) validateStockForRow(entry); }); 
    transactionForm.addEventListener('change', e => { const entry = e.target.closest('.wine-entry'); if(entry) validateStockForRow(entry); if (e.target.id === 'type') document.querySelectorAll('#wineEntries .wine-entry').forEach(validateStockForRow); }); 
    
    editForm.addEventListener('input', e => { const entry = e.target.closest('.wine-entry'); if (entry) validateStockForRow(entry, 'editType'); }); 
    editForm.addEventListener('change', e => { const entry = e.target.closest('.wine-entry'); if(entry) validateStockForRow(entry, 'editType'); if (e.target.id === 'editType') document.querySelectorAll('#editWineEntries .wine-entry').forEach(entry => validateStockForRow(entry, 'editType')); }); 
}

function validateQuickForm() { 
    const type = document.getElementById('quickType').value; 
    const validatorEl = document.getElementById('quickStockValidator'); 
    validatorEl.textContent = ''; 
    validatorEl.className = 'stock-validator'; 
    if (type !== 'sortie') return; 
    const wineId = parseInt(document.getElementById('quickWine').value); 
    const cases = parseInt(document.getElementById('quickQtyCases').value) || 0; 
    const bottles = parseInt(document.getElementById('quickQtyBottles').value) || 0; 
    if (!wineId || (cases === 0 && bottles === 0)) return; 
    const wine = state.wines.find(w => w.id === wineId); 
    if (!wine) return; 
    const stockInfo = getWineStockInfo(wine);
    const totalQuantityNeeded = (cases * wine.bottles_per_case) + bottles; 
    if (totalQuantityNeeded > stockInfo.total) { 
        validatorEl.textContent = `⚠️ Stock insuffisant (Reste : ${stockInfo.total})`; 
        validatorEl.classList.add('invalid'); 
    } else { 
        validatorEl.textContent = '✅ En stock'; 
        validatorEl.classList.add('valid'); 
    } 
}

function validateStockForRow(entryElement, typeFieldId = 'type') { 
    const type = document.getElementById(typeFieldId).value; 
    const validatorEl = entryElement.querySelector('.stock-validator'); 
    validatorEl.textContent = ''; 
    validatorEl.className = 'stock-validator'; 
    if (type !== 'sortie') return; 
    const wineId = parseInt(entryElement.querySelector('.wine-select').value); 
    const cases = parseInt(entryElement.querySelector('.wine-cases').value) || 0; 
    const bottles = parseInt(entryElement.querySelector('.wine-bottles').value) || 0; 
    if (!wineId || (cases === 0 && bottles === 0)) return; 
    const wine = state.wines.find(w => w.id === wineId); 
    if (!wine) return; 
    
    let stockInfo = getWineStockInfo(wine);
    
    // Si on modifie une transaction, on doit considérer le stock restauré
    if (typeFieldId === 'editType' && state.editingTransaction) {
        const oldWine = (state.editingTransaction.wines_involved || []).find(w => w.id === wineId);
        if (oldWine) {
            const oldMultiplier = state.editingTransaction.type === 'sortie' ? 1 : -1;
            const restoredCases = stockInfo.cases + ((oldWine.cases || 0) * oldMultiplier);
            const restoredBottles = stockInfo.bottles + ((oldWine.bottles || 0) * oldMultiplier);
            stockInfo = {
                cases: restoredCases,
                bottles: restoredBottles,
                total: restoredCases * wine.bottles_per_case + restoredBottles
            };
        }
    }
    
    const totalQuantityNeeded = (cases * wine.bottles_per_case) + bottles; 
    if (totalQuantityNeeded > stockInfo.total) { 
        validatorEl.textContent = `⚠️ Stock insuffisant (Reste : ${stockInfo.total})`; 
        validatorEl.classList.add('invalid'); 
    } else { 
        validatorEl.textContent = '✅ En stock'; 
        validatorEl.classList.add('valid'); 
    } 
}

function updateWineSelects() { 
    document.querySelectorAll('.wine-select').forEach(select => { 
        const currentVal = select.value; 
        select.innerHTML = '<option value="">Choisir un vin...</option>'; 
        ['rouge', 'blanc', 'rose', 'champagne'].forEach(type => { 
            const winesOfType = state.wines.filter(w => w.type === type); 
            if (winesOfType.length > 0) { 
                const optgroup = document.createElement('optgroup'); 
                optgroup.label = `${getWineEmoji(type)} ${type.charAt(0).toUpperCase() + type.slice(1)}s`; 
                winesOfType.sort((a,b) => a.name.localeCompare(b.name)).forEach(wine => { 
                    optgroup.innerHTML += `<option value="${wine.id}">${wine.name}</option>`; 
                }); 
                select.appendChild(optgroup); 
            } 
        }); 
        select.value = currentVal; 
    }); 
}

function exportData() { 
    let csvContent = "data:text/csv;charset=utf-8,ID Vin,Nom,Type,Stock Caisses,Stock Bouteilles,Total Bouteilles,Bouteilles par Caisse\r\n"; 
    state.wines.forEach(w => { 
        const stockInfo = getWineStockInfo(w);
        csvContent += `${w.id},"${w.name}",${w.type},${stockInfo.cases},${stockInfo.bottles},${stockInfo.total},${w.bottles_per_case}\r\n`; 
    }); 
    const link = document.createElement("a"); 
    link.href = encodeURI(csvContent); 
    link.download = `inventaire_${new Date().toISOString().split('T')[0]}.csv`; 
    link.click(); 
}

function printInventory() { 
    const printWindow = window.open('', '_blank'); 
    printWindow.document.write(`<html><head><title>Inventaire des Vins</title><style>body{font-family:sans-serif;padding:20px;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ccc; padding:8px; text-align:left;}</style></head><body><h1>Inventaire au ${new Date().toLocaleDateString('fr-FR')}</h1>${document.querySelector('#detailedInventory').parentElement.outerHTML}</body></html>`); 
    printWindow.document.close(); 
    setTimeout(() => printWindow.print(), 500); 
}
</script>
</body>
</html>
