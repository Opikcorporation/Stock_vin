<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Stock en Ligne - La Boutique Concept</title>
    <style>
        :root {
            --primary-color: #007aff;
            --primary-light-color: #e6f2ff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107; /* Orange for low stock warning */
            --text-color: #1d1d1f;
            --text-light-color: #6e6e73;
            --background-color: #f5f5f7;
            --card-background-color: #ffffff;
            --border-color: #e5e5e7;
            --border-radius: 12px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .header { text-align: center; margin-bottom: 32px; }
        .header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 4px; }
        .header h2 { font-size: 1.25rem; font-weight: 400; color: var(--text-light-color); }
        .nav-tabs { display: flex; gap: 8px; margin-bottom: 32px; border-bottom: 1px solid var(--border-color); }
        .nav-tab { padding: 12px 18px; background: none; border: none; font-size: 1rem; font-weight: 500; color: var(--text-light-color); cursor: pointer; transition: all 0.2s ease-in-out; border-bottom: 3px solid transparent; position: relative; top: 1px; }
        .nav-tab:hover { color: var(--text-color); }
        .nav-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background-color: var(--card-background-color); padding: 24px 32px; border-radius: var(--border-radius); margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
        .card-header { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--background-color); }
        .card-title { font-size: 1.5rem; font-weight: 600; }
        .form-group { margin-bottom: 16px; position: relative; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; background-color: #fdfdfd; }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-light-color); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn:disabled { background-color: #e9e9eb; color: #aaa; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { opacity: 0.85; }
        .btn-secondary { background-color: #e9e9eb; color: var(--text-color); }
        .btn-secondary:hover:not(:disabled) { background-color: #dcdce0; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover:not(:disabled) { opacity: 0.85; }
        .form-actions { display: flex; gap: 12px; margin-top: 24px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-weight: 600; font-size: 0.85rem; color: var(--text-light-color); text-transform: uppercase; letter-spacing: 0.5px; background-color: var(--background-color); }
        tbody tr:hover { background-color: #fafafa; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .low-stock-card { background: var(--card-background-color); padding: 20px; border-radius: var(--border-radius); border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .low-stock-card .info { display: flex; flex-direction: column; }
        .low-stock-card .name { font-weight: 600; font-size: 1.1rem; }
        .low-stock-card .type { font-size: 0.8rem; padding: 2px 8px; border-radius: 6px; display: inline-block; margin-top: 4px; color: white; }
        .low-stock-card .stock { font-size: 2.5rem; font-weight: 700; line-height: 1; }
        .stock.critical { color: var(--danger-color); }
        .stock.warning { color: var(--warning-color); }
        .wine-entries { display: flex; flex-direction: column; gap: 16px; background-color: var(--background-color); padding: 16px; border-radius: 8px; margin-top: 24px; }
        .wine-entry { background: var(--card-background-color); padding: 16px; border-radius: 8px; display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 16px; align-items: flex-start; }
        .remove-btn { height: 45px; padding: 0 16px; margin-top: 29px; }
        .stock-validator { font-size: 0.85rem; margin-top: 6px; min-height: 1.4em; }
        .stock-validator.valid { color: var(--success-color); }
        .stock-validator.invalid { color: var(--danger-color); }
        .type-badge { font-size: 0.8rem; padding: 3px 10px; border-radius: 12px; color: white; display: inline-block; text-transform: capitalize; }
        .badge-rouge { background-color: #9b2226; }
        .badge-blanc { background-color: #f7d351; color: #333; }
        .badge-rose { background-color: #f2a6a6; color: #333; }
        .badge-champagne { background-color: #e8bd4a; color: #333; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; display: inline-block; text-transform: uppercase; }
        .status-in { background-color: #d1f4d1; color: #00691e; }
        .status-out { background-color: #ffd1d1; color: #d70015; }
        .status-return { background-color: #cce5ff; color: #004085; }
        .alert { padding: 16px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; font-weight: 500; border: 1px solid transparent; }
        .alert-success { background-color: var(--primary-light-color); color: var(--primary-color); border-color: var(--primary-color); }
        .alert-warning { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translate(-50%, 200%); background-color: var(--text-color); color: white; padding: 14px 22px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: 500; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1000; }
        .toast.show { transform: translate(-50%, 0); }
        .footer-by-osmaweb { text-align: center; font-size: 0.8rem; color: var(--text-light-color); margin-top: 40px; padding-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Gestion de Stock</h1>
            <h2>La Boutique Concept</h2>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">üìä Tableau de bord</button>
            <button class="nav-tab" data-tab="transactions">üìù Transactions</button>
            <button class="nav-tab" data-tab="catalog">üç∑ Catalogue</button>
            <button class="nav-tab" data-tab="analysis">üìà Analyse</button>
            <button class="nav-tab" data-tab="settings">‚öôÔ∏è Param√®tres</button>
        </nav>

        <div id="dashboard" class="tab-content active">
            <div class="dashboard-grid" id="lowStockDashboard"></div>
            <div class="card">
                <div class="card-header"><h2 class="card-title">Inventaire D√©taill√©</h2></div>
                <table><thead><tr><th>Vin</th><th>Stock (Caisses)</th><th>Stock (Bouteilles)</th><th>Total Bouteilles</th></tr></thead><tbody id="detailedInventory"></tbody></table>
            </div>
            <div class="card">
                <div class="card-header"><h2 class="card-title">Transaction Rapide</h2></div>
                <form id="quickForm">
                     <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; align-items:flex-start;">
                        <div class="form-group"><label class="form-label" for="quickType">Type</label><select class="form-control" id="quickType" name="quickType" required><option value="">S√©lectionner...</option><option value="entree">üì• Entr√©e</option><option value="sortie">üì§ Sortie</option><option value="retour">‚Ü©Ô∏è Retour</option></select></div>
                        <div class="form-group"><label class="form-label" for="quickWine">Vin</label><select class="form-control wine-select" id="quickWine" name="quickWine" required></select></div>
                        <div class="form-group"><label class="form-label" for="quickQtyCases">Qt√© (Caisses)</label><input type="number" class="form-control" id="quickQtyCases" name="quickQtyCases" min="0" placeholder="0"></div>
                        <div class="form-group"><label class="form-label" for="quickQtyBottles">Qt√© (Bouteilles)</label><input type="number" class="form-control" id="quickQtyBottles" name="quickQtyBottles" min="0" placeholder="0"><div class="stock-validator" id="quickStockValidator"></div></div>
                    </div>
                    <div class="form-actions"><button type="submit" class="btn btn-primary">Valider la Transaction</button></div>
                </form>
            </div>
        </div>
        <div id="transactions" class="tab-content">
            <div class="card">
                <div class="card-header"><h2 class="card-title">Nouvelle Transaction</h2></div>
                <form id="transactionForm">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div class="form-group"><label class="form-label" for="date">Date</label><input type="date" class="form-control" id="date" name="date" required></div>
                        <div class="form-group"><label class="form-label" for="type">Type</label><select class="form-control" id="type" name="type" required><option value="">S√©lectionner...</option><option value="entree">üì• Entr√©e</option><option value="sortie">üì§ Sortie</option><option value="retour">‚Ü©Ô∏è Retour</option></select></div>
                        <div class="form-group"><label class="form-label" for="reference">R√©f√©rence</label><input type="text" class="form-control" id="reference" name="reference" placeholder="Ex: Mariage Dupont"></div>
                    </div>
                    <div class="wine-entries" id="wineEntries"></div>
                    <div class="form-actions"><button type="button" class="btn btn-secondary" id="addWineBtn">+ Ajouter un vin</button><button type="submit" class="btn btn-primary">Enregistrer la Transaction</button></div>
                </form>
            </div>
            <div class="card">
                <div class="card-header"><h2 class="card-title">Historique des Transactions</h2></div>
                <input type="search" class="form-control" id="searchInput" placeholder="Rechercher une transaction..." style="max-width: 400px; margin-bottom: 20px;">
                <table><thead><tr><th>Date</th><th>Type</th><th>Vins (Qt√© Bouteilles)</th><th>R√©f√©rence</th><th>Actions</th></tr></thead><tbody id="transactionsTable"></tbody></table>
            </div>
        </div>
        <div id="catalog" class="tab-content">
            <div class="card">
                <div class="card-header"><h2 class="card-title">Ajouter un Vin au Catalogue</h2></div>
                <form id="addWineForm" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 16px; align-items: flex-end;">
                    <div class="form-group" style="margin-bottom:0;"><label class="form-label" for="wineName">Nom du Vin</label><input type="text" class="form-control" id="wineName" required></div>
                    <div class="form-group" style="margin-bottom:0;"><label class="form-label" for="wineType">Type</label><select class="form-control" id="wineType" required><option value="">S√©lectionner...</option><option value="rouge">Rouge</option><option value="blanc">Blanc</option><option value="rose">Ros√©</option><option value="champagne">Champagne</option></select></div>
                    <div class="form-group" style="margin-bottom:0;"><label class="form-label" for="bottlesPerCase">Bouteilles / caisse</label><input type="number" class="form-control" id="bottlesPerCase" min="1" required placeholder="Ex: 6"></div>
                    <button type="submit" class="btn btn-primary" style="height:45px;">Ajouter</button>
                </form>
            </div>
             <div class="card">
                <div class="card-header"><h2 class="card-title">Vins au Catalogue</h2></div>
                <input type="search" class="form-control" id="wineSearch" placeholder="Rechercher un vin..." style="max-width: 400px; margin-bottom: 20px;">
                <table><thead><tr><th>Nom</th><th>Type</th><th>Bouteilles / Caisse</th><th>Action</th></tr></thead><tbody id="wineList"></tbody></table>
             </div>
        </div>
        <div id="analysis" class="tab-content">
             <div class="card">
                <div class="card-header"><h2 class="card-title">Analyse des Consommations et Retours</h2></div>
                <table><thead><tr><th>Vin</th><th>Total Sorties</th><th>Total Retours</th><th>Consommation Nette</th><th>Taux de Retour</th></tr></thead><tbody id="analysisTable"></tbody></table>
            </div>
        </div>
        <div id="settings" class="tab-content">
            <div class="card">
                <div class="card-header"><h2 class="card-title">Param√®tres G√©n√©raux</h2></div>
                <div class="form-group" style="max-width:300px;"><label class="form-label" for="threshold">Seuil d'alerte (bouteilles restantes)</label><input type="number" class="form-control" id="threshold" value="12" min="0"></div>
                <div class="form-actions"><button class="btn btn-secondary" onclick="exportData()">üìä Exporter (CSV)</button><button class="btn btn-secondary" onclick="printInventory()">üñ®Ô∏è Imprimer l'Inventaire</button></div>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"><span id="toastMsg"></span></div>
    <div class="footer-by-osmaweb">Con√ßu et d√©velopp√© par Osmaweb & Gemini</div>

<script>
const SUPABASE_URL = "VOTRE_URL_SUPABASE";
const SUPABASE_KEY = "VOTRE_CLE_API_ANON";

const apiHeaders = { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

let state = { wines: [], transactions: [], threshold: 12 };

document.addEventListener('DOMContentLoaded', () => {
    if (SUPABASE_URL === "VOTRE_URL_SUPABASE" || SUPABASE_KEY === "VOTRE_CLE_API_ANON") {
        document.body.innerHTML = `<div style="padding:40px; text-align:center; background: #fff3cd; color:#856404; font-family: sans-serif;">
            <h1>Configuration Requise</h1>
            <p>Veuillez modifier le fichier HTML pour remplacer <strong>VOTRE_URL_SUPABASE</strong> et <strong>VOTRE_CLE_API_ANON</strong> par vos propres cl√©s API Supabase.</p>
        </div>`;
        return;
    }
    initApp();
});

async function initApp() {
    showToast('Chargement des donn√©es...');
    await loadDataFromSupabase();
    initEventListeners();
    addWineEntry();
    updateAll();
    showToast('Application pr√™te !');
}

function initEventListeners() {
    document.querySelectorAll('.nav-tab').forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
    document.getElementById('quickForm').addEventListener('submit', handleQuickTransaction);
    document.getElementById('transactionForm').addEventListener('submit', handleTransaction);
    document.getElementById('addWineForm').addEventListener('submit', handleAddWine);
    document.getElementById('addWineBtn').addEventListener('click', () => addWineEntry());
    document.getElementById('searchInput').addEventListener('input', updateTransactionsTable);
    document.getElementById('wineSearch').addEventListener('input', updateWineList);
    document.getElementById('threshold').addEventListener('change', e => { state.threshold = parseInt(e.target.value) || 0; updateDashboard(); });
    document.getElementById('date').valueAsDate = new Date();
    initRealTimeValidation();
}

async function loadDataFromSupabase() {
    try {
        const [winesRes, transactionsRes] = await Promise.all([
            fetch(`${SUPABASE_URL}/rest/v1/wines?select=*`, { headers: apiHeaders }),
            fetch(`${SUPABASE_URL}/rest/v1/transactions?select=*`, { headers: apiHeaders })
        ]);
        if (!winesRes.ok || !transactionsRes.ok) throw new Error("Erreur r√©seau");
        state.wines = await winesRes.json();
        state.transactions = await transactionsRes.json();
    } catch (error) {
        console.error("Erreur de chargement:", error);
        showToast("Impossible de charger les donn√©es.");
    }
}

async function handleAddWine(e) {
    e.preventDefault();
    setFormDisabled(true);
    const name = document.getElementById('wineName').value.trim();
    const type = document.getElementById('wineType').value;
    const bottlesPerCase = parseInt(document.getElementById('bottlesPerCase').value);
    if (!name || !type || !bottlesPerCase) { showToast('‚ö†Ô∏è Veuillez remplir tous les champs.'); setFormDisabled(false); return; }
    if (state.wines.some(w => w.name.toLowerCase() === name.toLowerCase())) { showToast('‚ö†Ô∏è Ce nom de vin existe d√©j√†.'); setFormDisabled(false); return; }
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/wines`, { method: 'POST', headers: apiHeaders, body: JSON.stringify({ name, type, bottles_per_case: bottlesPerCase, stock: 0 }) });
        if (!response.ok) throw new Error('√âchec de la cr√©ation du vin.');
        const newWine = await response.json();
        state.wines.push(newWine[0]);
        e.target.reset();
        updateAll();
        showToast('üç∑ Vin ajout√© au catalogue');
    } catch (error) { showToast("Erreur lors de l'ajout du vin."); console.error(error); }
    setFormDisabled(false);
}

async function handleQuickTransaction(e) { e.preventDefault(); await processTransaction(new FormData(e.target), 'quick'); }
async function handleTransaction(e) { e.preventDefault(); await processTransaction(new FormData(e.target), 'detailed'); }

async function processTransaction(formData, formType) {
    setFormDisabled(true);
    const type = formData.get(formType === 'quick' ? 'quickType' : 'type');
    const reference = formData.get('reference') || 'Transaction rapide';
    const date = formData.get('date') || new Date().toISOString().split('T')[0];
    let winesInTx = [], stockCheckFailed = false;

    if (formType === 'quick') {
        const wineId = parseInt(formData.get('quickWine')), cases = parseInt(formData.get('quickQtyCases')) || 0, bottles = parseInt(formData.get('quickQtyBottles')) || 0;
        const wine = state.wines.find(w => w.id === wineId);
        if (wine && (cases > 0 || bottles > 0)) {
            const quantity = (cases * wine.bottles_per_case) + bottles;
            if (type === 'sortie' && wine.stock < quantity) stockCheckFailed = true;
            winesInTx.push({ ...wine, quantity });
        }
    } else {
        document.querySelectorAll('#wineEntries .wine-entry').forEach(entry => {
            const wineId = parseInt(entry.querySelector('.wine-select').value), cases = parseInt(entry.querySelector('.wine-cases').value) || 0, bottles = parseInt(entry.querySelector('.wine-bottles').value) || 0;
            const wine = state.wines.find(w => w.id === wineId);
            if(wine && (cases > 0 || bottles > 0)) {
                const quantity = (cases * wine.bottles_per_case) + bottles;
                if (type === 'sortie' && wine.stock < quantity) stockCheckFailed = true;
                winesInTx.push({ ...wine, quantity });
            }
        });
    }

    if (!type) { showToast('‚ö†Ô∏è Veuillez s√©lectionner un type de transaction.'); setFormDisabled(false); return; }
    if (winesInTx.length === 0) { showToast('‚ö†Ô∏è Veuillez ajouter au moins un vin avec une quantit√©.'); setFormDisabled(false); return; }
    if (stockCheckFailed) { showToast('‚ö†Ô∏è Transaction annul√©e : stock insuffisant.'); setFormDisabled(false); return; }
    
    const multiplier = type === 'sortie' ? -1 : 1;
    const stockUpdatePromises = winesInTx.map(txWine => {
        const newStock = txWine.stock + (txWine.quantity * multiplier);
        return fetch(`${SUPABASE_URL}/rest/v1/wines?id=eq.${txWine.id}`, { method: 'PATCH', headers: apiHeaders, body: JSON.stringify({ stock: newStock }) });
    });

    try {
        const stockUpdateResponses = await Promise.all(stockUpdatePromises);
        stockUpdateResponses.forEach(res => { if (!res.ok) throw new Error('√âchec de la mise √† jour du stock.'); });
        const wines_involved = winesInTx.map(w => ({ id: w.id, name: w.name, quantity: w.quantity }));
        const txResponse = await fetch(`${SUPABASE_URL}/rest/v1/transactions`, { method: 'POST', headers: apiHeaders, body: JSON.stringify({ date, type, reference, wines_involved }) });
        if (!txResponse.ok) throw new Error('√âchec de l\'enregistrement de la transaction.');
        await loadDataFromSupabase();
        if (formType === 'quick') document.getElementById('quickForm').reset(); else resetTransactionForm();
        updateAll();
        showToast('‚úÖ Transaction enregistr√©e.');
    } catch (error) { showToast("Erreur lors de la transaction."); console.error(error); }
    setFormDisabled(false);
}

async function deleteWine(id) {
    if (state.transactions.some(t => t.wines_involved.some(w => w.id === id))) return showToast('‚ö†Ô∏è Impossible : ce vin est utilis√© dans des transactions.');
    if (!confirm('Voulez-vous vraiment supprimer ce vin du catalogue ?')) return;
    setFormDisabled(true);
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/wines?id=eq.${id}`, { method: 'DELETE', headers: apiHeaders });
        if (!response.ok) throw new Error('√âchec de la suppression.');
        state.wines = state.wines.filter(w => w.id !== id);
        updateAll();
        showToast('üóëÔ∏è Vin supprim√© du catalogue');
    } catch (error) { showToast("Erreur lors de la suppression."); }
    setFormDisabled(false);
}

async function deleteTransaction(id) {
    if (!confirm('Voulez-vous vraiment supprimer cette transaction ? Le stock sera recalcul√©.')) return;
    setFormDisabled(true);
    const tx = state.transactions.find(t => t.id === id);
    if (!tx) return setFormDisabled(false);
    const multiplier = tx.type === 'sortie' ? 1 : -1;
    const stockUpdatePromises = tx.wines_involved.map(txWine => {
        const wineInState = state.wines.find(w => w.id === txWine.id);
        if (!wineInState) return Promise.resolve();
        const newStock = wineInState.stock + (txWine.quantity * multiplier);
        return fetch(`${SUPABASE_URL}/rest/v1/wines?id=eq.${txWine.id}`, { method: 'PATCH', headers: apiHeaders, body: JSON.stringify({ stock: newStock }) });
    });
    try {
        await Promise.all(stockUpdatePromises);
        const deleteTxResponse = await fetch(`${SUPABASE_URL}/rest/v1/transactions?id=eq.${id}`, { method: 'DELETE', headers: apiHeaders });
        if (!deleteTxResponse.ok) throw new Error('√âchec de la suppression.');
        await loadDataFromSupabase();
        updateAll();
        showToast('üóëÔ∏è Transaction supprim√©e et stock recalcul√©.');
    } catch(error) { showToast("Erreur lors de l'annulation de la transaction."); console.error(error); }
    setFormDisabled(false);
}

function updateDashboard() {
    const dashboardContainer = document.getElementById('lowStockDashboard');
    if (state.wines.length === 0) { dashboardContainer.innerHTML = '<div class="alert alert-success" style="grid-column: 1 / -1;">Commencez par ajouter des vins √† votre catalogue.</div>'; }
    else {
        const lowStockWines = [...state.wines].sort((a, b) => a.stock - b.stock).slice(0, 4);
        dashboardContainer.innerHTML = lowStockWines.map(wine => {
            let stockClass = '';
            if (wine.stock <= state.threshold) stockClass = 'critical';
            else if (wine.stock <= state.threshold * 2) stockClass = 'warning';
            return `<div class="low-stock-card"><div class="info"><span class="name">${wine.name}</span><span class="type-badge badge-${wine.type}">${wine.type}</span></div><div class="stock ${stockClass}">${wine.stock}</div></div>`;
        }).join('');
    }
    const inventoryBody = document.getElementById('detailedInventory');
    if (state.wines.length === 0) { inventoryBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 40px;">Votre inventaire est vide.</td></tr>'; }
    else { inventoryBody.innerHTML = [...state.wines].sort((a,b) => a.name.localeCompare(b.name)).map(wine => { const cases = Math.floor(wine.stock / wine.bottles_per_case); const bottles = wine.stock % wine.bottles_per_case; return `<tr><td>${getWineEmoji(wine.type)} ${wine.name}</td><td>${cases}</td><td>${bottles}</td><td><strong>${wine.stock}</strong></td></tr>`; }).join(''); }
}

function updateTransactionsTable() {
    const tbody = document.getElementById('transactionsTable');
    const search = document.getElementById('searchInput').value.toLowerCase();
    const filtered = state.transactions.filter(t => (t.date + t.reference + (t.wines_involved || []).map(w => w.name).join(' ')).toLowerCase().includes(search));
    if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px;">Aucune transaction trouv√©e.</td></tr>'; return; }
    tbody.innerHTML = filtered.sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => `<tr><td>${new Date(t.date).toLocaleDateString('fr-FR')}</td><td><span class="status-badge status-${{entree:'in', sortie:'out', retour:'return'}[t.type]}">${t.type}</span></td><td>${(t.wines_involved || []).map(w => `${w.name} (${w.quantity})`).join(', ')}</td><td>${t.reference || 'N/A'}</td><td><button class="btn btn-danger btn-small" style="padding: 6px 12px; font-size: 0.8rem;" onclick="deleteTransaction(${t.id})">Supprimer</button></td></tr>`).join('');
}

function updateWineList() {
    const tbody = document.getElementById('wineList');
    const search = document.getElementById('wineSearch').value.toLowerCase();
    const filtered = state.wines.filter(w => w.name.toLowerCase().includes(search));
    if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 40px;">Aucun vin ne correspond √† votre recherche.</td></tr>'; return; }
    tbody.innerHTML = [...filtered].sort((a,b) => a.name.localeCompare(b.name)).map(wine => `<tr><td>${getWineEmoji(wine.type)} ${wine.name}</td><td><span class="type-badge badge-${wine.type}">${wine.type}</span></td><td>${wine.bottles_per_case}</td><td><button class="btn btn-danger btn-small" style="padding: 6px 12px; font-size: 0.8rem;" onclick="deleteWine(${wine.id})">Supprimer</button></td></tr>`).join('');
}

function updateAnalysisTable() {
    const tbody = document.getElementById('analysisTable');
    if (state.wines.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px;">Aucune donn√©e √† analyser.</td></tr>'; return; }
    const analysisData = state.wines.map(wine => {
        const movements = { sortie: 0, retour: 0 };
        state.transactions.forEach(t => { const wineInTx = (t.wines_involved || []).find(w => w.id === wine.id); if (wineInTx && movements.hasOwnProperty(t.type)) movements[t.type] += wineInTx.quantity; });
        const netConsumption = movements.sortie - movements.retour;
        const returnRate = movements.sortie > 0 ? ((movements.retour / movements.sortie) * 100).toFixed(1) : 0;
        return { name: wine.name, type: wine.type, ...movements, netConsumption, returnRate };
    });
    tbody.innerHTML = analysisData.map(data => `<tr><td>${getWineEmoji(data.type)} ${data.name}</td><td>${data.sortie}</td><td>${data.retour}</td><td><strong>${data.netConsumption}</strong></td><td>${data.returnRate} %</td></tr>`).join('');
}

function setFormDisabled(isDisabled) { document.querySelectorAll('button, input, select').forEach(el => el.disabled = isDisabled); }
function switchTab(tabName) { document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.querySelector(`[data-tab="${tabName}"]`).classList.add('active'); document.getElementById(tabName).classList.add('active'); const updateFn = { 'dashboard': updateDashboard, 'transactions': updateTransactionsTable, 'catalog': updateWineList, 'analysis': updateAnalysisTable }[tabName]; if (updateFn) updateFn(); }
function updateAll() { updateDashboard(); updateWineSelects(); updateTransactionsTable(); updateWineList(); updateAnalysisTable(); }
function showToast(message) { const toast = document.getElementById('toast'); document.getElementById('toastMsg').textContent = message; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); }
function addWineEntry() { const container = document.getElementById('wineEntries'); const newId = Date.now(); const entryDiv = document.createElement('div'); entryDiv.className = 'wine-entry'; entryDiv.innerHTML = `<div class="form-group"><label class="form-label" for="wine-select-${newId}">Vin</label><select class="form-control wine-select" id="wine-select-${newId}" required></select></div><div class="form-group"><label class="form-label" for="wine-cases-${newId}">Caisses</label><input type="number" class="form-control wine-cases" id="wine-cases-${newId}" min="0" placeholder="0"></div><div class="form-group"><label class="form-label" for="wine-bottles-${newId}">Bouteilles</label><input type="number" class="form-control wine-bottles" id="wine-bottles-${newId}" min="0" placeholder="0"><div class="stock-validator"></div></div><button type="button" class="btn btn-danger remove-btn">‚úï</button>`; container.appendChild(entryDiv); updateWineSelects(); entryDiv.querySelector('.remove-btn').addEventListener('click', () => entryDiv.remove()); }
function resetTransactionForm() { document.getElementById('transactionForm').reset(); document.getElementById('date').valueAsDate = new Date(); document.getElementById('wineEntries').innerHTML = ''; addWineEntry(); }
function getWineEmoji(type) { return { rouge: 'üç∑', blanc: 'ü•Ç', rose: 'üåπ', champagne: 'üçæ' }[type] || 'üçá'; }
function initRealTimeValidation() { const quickForm = document.getElementById('quickForm'); const transactionForm = document.getElementById('transactionForm'); quickForm.addEventListener('input', e => { if (['quickQtyCases', 'quickQtyBottles'].includes(e.target.id)) validateQuickForm(); }); quickForm.addEventListener('change', e => { if (['quickType', 'quickWine'].includes(e.target.id)) validateQuickForm(); }); transactionForm.addEventListener('input', e => { const entry = e.target.closest('.wine-entry'); if (entry) validateStockForRow(entry); }); transactionForm.addEventListener('change', e => { const entry = e.target.closest('.wine-entry'); if(entry) validateStockForRow(entry); if (e.target.id === 'type') document.querySelectorAll('.wine-entry').forEach(validateStockForRow); }); }
function validateQuickForm() { const type = document.getElementById('quickType').value; const validatorEl = document.getElementById('quickStockValidator'); validatorEl.textContent = ''; validatorEl.className = 'stock-validator'; if (type !== 'sortie') return; const wineId = parseInt(document.getElementById('quickWine').value); const cases = parseInt(document.getElementById('quickQtyCases').value) || 0; const bottles = parseInt(document.getElementById('quickQtyBottles').value) || 0; if (!wineId || (cases === 0 && bottles === 0)) return; const wine = state.wines.find(w => w.id === wineId); if (!wine) return; const totalQuantityNeeded = (cases * wine.bottles_per_case) + bottles; if (totalQuantityNeeded > wine.stock) { validatorEl.textContent = `‚ö†Ô∏è Stock insuffisant (Reste : ${wine.stock})`; validatorEl.classList.add('invalid'); } else { validatorEl.textContent = '‚úÖ En stock'; validatorEl.classList.add('valid'); } }
function validateStockForRow(entryElement) { const type = document.getElementById('type').value; const validatorEl = entryElement.querySelector('.stock-validator'); validatorEl.textContent = ''; validatorEl.className = 'stock-validator'; if (type !== 'sortie') return; const wineId = parseInt(entryElement.querySelector('.wine-select').value); const cases = parseInt(entryElement.querySelector('.wine-cases').value) || 0; const bottles = parseInt(entryElement.querySelector('.wine-bottles').value) || 0; if (!wineId || (cases === 0 && bottles === 0)) return; const wine = state.wines.find(w => w.id === wineId); if (!wine) return; const totalQuantityNeeded = (cases * wine.bottles_per_case) + bottles; if (totalQuantityNeeded > wine.stock) { validatorEl.textContent = `‚ö†Ô∏è Stock insuffisant (Reste : ${wine.stock})`; validatorEl.classList.add('invalid'); } else { validatorEl.textContent = '‚úÖ En stock'; validatorEl.classList.add('valid'); } }
function updateWineSelects() { document.querySelectorAll('.wine-select').forEach(select => { const currentVal = select.value; select.innerHTML = '<option value="">Choisir un vin...</option>'; ['rouge', 'blanc', 'rose', 'champagne'].forEach(type => { const winesOfType = state.wines.filter(w => w.type === type); if (winesOfType.length > 0) { const optgroup = document.createElement('optgroup'); optgroup.label = `${getWineEmoji(type)} ${type.charAt(0).toUpperCase() + type.slice(1)}s`; winesOfType.sort((a,b) => a.name.localeCompare(b.name)).forEach(wine => { optgroup.innerHTML += `<option value="${wine.id}">${wine.name}</option>`; }); select.appendChild(optgroup); } }); select.value = currentVal; }); }
function exportData() { let csvContent = "data:text/csv;charset=utf-8,ID Vin,Nom,Type,Stock,Bouteilles par Caisse\r\n"; state.wines.forEach(w => { csvContent += `${w.id},"${w.name}",${w.type},${w.stock},${w.bottles_per_case}\r\n`; }); const link = document.createElement("a"); link.href = encodeURI(csvContent); link.download = `inventaire_${new Date().toISOString().split('T')[0]}.csv`; link.click(); }
function printInventory() { const printWindow = window.open('', '_blank'); printWindow.document.write(`<html><head><title>Inventaire des Vins</title><style>body{font-family:sans-serif;padding:20px;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ccc; padding:8px; text-align:left;}</style></head><body><h1>Inventaire au ${new Date().toLocaleDateString('fr-FR')}</h1>${document.querySelector('#detailedInventory').parentElement.outerHTML}</body></html>`); printWindow.document.close(); setTimeout(() => printWindow.print(), 500); }
</script>
</body>
</html>